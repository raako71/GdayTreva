<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Time Server</title>
    <link rel="stylesheet" href="/styles.css"> <!-- Link to external stylesheet -->
</head>
<body>
    <!-- Narrow div at the top showing time on the left -->
    <div id="timeBar" class="time-bar">
        <a id="timeLink" href="#" onclick="showSyncOverlay()">Loading...</a>
    </div>

    <!-- Overlay for syncing time and timezone -->
    <div id="syncOverlay" class="overlay" style="display: none;">
        <div class="overlay-content">
            <h2>Sync Time and Timezone</h2>
            <p>Click the button below to sync your local time and timezone with the server.</p>
            <button onclick="syncTimeAndTimezone()">Sync Local Time and Timezone</button>
        </div>
    </div>

    <!-- JavaScript for WebSocket, time updates, and sync logic -->
    <script>
        // WebSocket connection to the ESP32
        const ws = new WebSocket('ws://' + window.location.hostname + '/ws');

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.time) {
                updateTime(data.time, data.tz);
            }
        };

        ws.onopen = function() {
            console.log('WebSocket connection opened');
        };

        ws.onclose = function() {
            console.log('WebSocket connection closed');
            document.getElementById('timeLink').textContent = 'Disconnected';
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        // Update time display with timezone and check sync
        function updateTime(serverTimeStr, serverTz) {
            const timeLink = document.getElementById('timeLink');
            // Convert POSIX timezone to UTC offset (e.g., "AEST-10" â†’ "UTC+10")
            let utcOffset = "UTC+0";
            if (serverTz) {
                const match = serverTz.match(/([A-Z]+)(-|\+)?(\d+)/);
                if (match) {
                    const offset = parseInt(match[3], 10);
                    utcOffset = "UTC" + (match[2] === "-" ? "+" : "-") + offset;
                }
            }
            timeLink.textContent = `${serverTimeStr} (${utcOffset})`;

            // Convert server time string to Date object (assuming format "YYYY-MM-DD HH:MM:SS")
            const serverTime = new Date(serverTimeStr);
            const clientTime = new Date();

            // Calculate time difference in seconds
            const timeDiff = Math.abs(clientTime - serverTime) / 1000; // Difference in seconds

            // Check if server time is more than 5 seconds off from client time
            if (timeDiff > 5) {
                timeLink.style.color = 'red'; // Set time to red if out of sync
            } else {
                timeLink.style.color = 'black'; // Default color if in sync
            }
        }

        // Show the sync overlay
        function showSyncOverlay() {
            document.getElementById('syncOverlay').style.display = 'block';
        }

        // Hide the sync overlay
        function hideSyncOverlay() {
            document.getElementById('syncOverlay').style.display = 'none';
        }

        // Sync local time and timezone to server
        function syncTimeAndTimezone() {
            const clientTime = new Date();
            const year = clientTime.getFullYear();
            const month = String(clientTime.getMonth() + 1).padStart(2, '0');
            const day = String(clientTime.getDate()).padStart(2, '0');
            const hours = String(clientTime.getHours()).padStart(2, '0');
            const minutes = String(clientTime.getMinutes()).padStart(2, '0');
            const seconds = String(clientTime.getSeconds()).padStart(2, '0');
            const timeStr = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            const posixTz = "AEST-10"; // Adjust to your POSIX timezone

            const message = { 
                command: 'sync_time', 
                time: timeStr, 
                tz: posixTz 
            };
            ws.send(JSON.stringify(message));
            console.log('Sent to server:', message);
            alert('Sent time: ' + timeStr + ' and timezone: ' + posixTz + ' to server.');
            hideSyncOverlay();
        }

        // Handle window clicks to close overlay if clicking outside
        window.onclick = function(event) {
            const overlay = document.getElementById('syncOverlay');
            if (event.target == overlay) {
                hideSyncOverlay();
            }
        };
    </script>
</body>
</html>